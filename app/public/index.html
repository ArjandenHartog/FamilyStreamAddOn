<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FamilyStream - Home Assistant Integratie</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background-color: #03a9f4;
      color: white;
      padding: 15px 0;
      text-align: center;
      margin-bottom: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    main {
      display: grid;
      grid-template-columns: 3fr 1fr;
      gap: 20px;
    }
    
    @media (max-width: 768px) {
      main {
        grid-template-columns: 1fr;
      }
    }
    
    .music-browser, .player-controls {
      background: white;
      border-radius: 5px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .music-browser {
      overflow-y: auto;
      max-height: 80vh;
    }
    
    .player-controls {
      position: sticky;
      top: 20px;
    }
    
    .section-title {
      font-size: 18px;
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }
    
    .song-list {
      list-style: none;
    }
    
    .song-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
    }
    
    .song-item:hover {
      background-color: #f9f9f9;
    }
    
    .song-item.active {
      background-color: #e3f2fd;
    }
    
    .song-title {
      font-weight: bold;
      flex: 1;
    }
    
    .song-artist {
      color: #666;
      font-size: 14px;
      margin-left: 10px;
    }
    
    .play-icon {
      margin-right: 10px;
      color: #03a9f4;
      font-size: 18px;
    }
    
    .control-group {
      margin-bottom: 20px;
    }
    
    .control-label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      font-size: 14px;
    }
    
    select, button {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
      font-size: 14px;
    }
    
    select {
      margin-bottom: 10px;
    }
    
    button {
      background-color: #03a9f4;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-bottom: 10px;
    }
    
    button:hover {
      background-color: #0288d1;
    }
    
    button:disabled {
      background-color: #b3e5fc;
      cursor: not-allowed;
    }
    
    .volume-control {
      width: 100%;
      margin: 10px 0;
    }
    
    .now-playing {
      background-color: #e3f2fd;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .now-playing-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .now-playing-artist {
      font-size: 14px;
      color: #666;
    }
    
    .status-message {
      padding: 10px;
      margin-top: 15px;
      border-radius: 5px;
      background-color: #f8f9fa;
      border-left: 4px solid #03a9f4;
      font-size: 14px;
    }
    
    .error {
      background-color: #fff8f8;
      border-left-color: #f44336;
    }
    
    .success {
      background-color: #f1f8e9;
      border-left-color: #8bc34a;
    }
    
    .loading {
      text-align: center;
      margin: 20px 0;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid rgba(3, 169, 244, 0.3);
      border-radius: 50%;
      border-top-color: #03a9f4;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .search-box {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
      margin-bottom: 20px;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    
    .tab {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }
    
    .tab.active {
      border-bottom-color: #03a9f4;
      font-weight: bold;
    }
    
    .tabs-content > div {
      display: none;
    }
    
    .tabs-content > div.active {
      display: block;
    }
    
    .song-duration {
      font-size: 12px;
      color: #666;
      margin-left: 10px;
    }
    
    /* Add prayer time styles */
    .prayer-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
    }
    
    .prayer-name {
      font-weight: bold;
    }
    
    .prayer-time {
      color: #666;
    }
    
    /* Playlist styles */
    .playlist-item {
      padding: 15px;
      border-radius: 5px;
      background: #f9f9f9;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .playlist-item:hover {
      background: #e3f2fd;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .playlist-name {
      font-weight: bold;
      font-size: 16px;
    }
    
    .playlist-details {
      font-size: 13px;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>FamilyStream Audio</h1>
      <p>Stream muziek naar Home Assistant mediaspelers</p>
    </header>
    
    <main>
      <div class="music-browser">
        <input type="text" class="search-box" id="search-input" placeholder="Zoek naar liedjes, albums of artiesten...">
        
        <div class="tabs">
          <div class="tab active" data-tab="songs">Liedjes</div>
          <div class="tab" data-tab="playlists">Afspeellijsten</div>
          <div class="tab" data-tab="prayer-times">Gebedstijden</div>
        </div>
        
        <div class="tabs-content">
          <div id="songs-tab" class="active">
            <h2 class="section-title">Populaire liedjes</h2>
            <div class="loading">
              <div class="loading-spinner"></div>
              <p>Liedjes laden...</p>
            </div>
            <ul class="song-list" id="songs-list">
              <!-- Songs will be loaded here -->
            </ul>
          </div>
          
          <div id="playlists-tab">
            <h2 class="section-title">Afspeellijsten</h2>
            <div class="loading">
              <div class="loading-spinner"></div>
              <p>Afspeellijsten laden...</p>
            </div>
            <div id="playlists-container">
              <!-- Playlists will be loaded here -->
            </div>
          </div>
          
          <div id="prayer-times-tab">
            <h2 class="section-title">Gebedstijden</h2>
            <div class="loading">
              <div class="loading-spinner"></div>
              <p>Gebedstijden laden...</p>
            </div>
            <div id="prayer-times-container">
              <!-- Prayer times will be loaded here -->
            </div>
          </div>
        </div>
      </div>
      
      <div class="player-controls">
        <div class="now-playing" id="now-playing">
          <div class="now-playing-title">Geen nummer geselecteerd</div>
          <div class="now-playing-artist">Selecteer een nummer om af te spelen</div>
        </div>
        
        <div class="control-group">
          <label class="control-label" for="media-player-select">Selecteer mediaspeler:</label>
          <select id="media-player-select">
            <option value="">Kies een mediaspeler...</option>
          </select>
          <button id="refresh-players-btn">Ververs mediaspelers</button>
        </div>
        
        <div class="control-group">
          <label class="control-label" for="volume-control">Volume:</label>
          <input type="range" id="volume-control" class="volume-control" min="0" max="100" value="50">
        </div>
        
        <div class="control-group">
          <button id="play-btn" disabled>▶️ Afspelen</button>
          <button id="pause-btn" disabled>⏸️ Pauzeren</button>
          <button id="stop-btn" disabled>⏹️ Stoppen</button>
        </div>
        
        <div class="status-message" id="status-message">
          Klaar om muziek af te spelen. Selecteer een nummer en een mediaspeler.
        </div>
      </div>
    </main>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // State
      let currentSong = null;
      let mediaPlayers = [];
      let currentEntityId = '';
      let songs = [];
      let playlists = [];
      
      // Elements
      const mediaPlayerSelect = document.getElementById('media-player-select');
      const refreshPlayersBtn = document.getElementById('refresh-players-btn');
      const volumeControl = document.getElementById('volume-control');
      const playBtn = document.getElementById('play-btn');
      const pauseBtn = document.getElementById('pause-btn');
      const stopBtn = document.getElementById('stop-btn');
      const searchInput = document.getElementById('search-input');
      const statusMessage = document.getElementById('status-message');
      const nowPlaying = document.getElementById('now-playing');
      const songsList = document.getElementById('songs-list');
      const playlistsContainer = document.getElementById('playlists-container');
      const prayerTimesContainer = document.getElementById('prayer-times-container');
      
      // Handle tabs
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tabs-content > div');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Remove active class from all tabs
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          // Add active class to current tab
          tab.classList.add('active');
          const tabId = tab.getAttribute('data-tab') + '-tab';
          document.getElementById(tabId).classList.add('active');
          
          // Load content for tab if needed
          if (tab.getAttribute('data-tab') === 'playlists' && playlists.length === 0) {
            loadPlaylists();
          } else if (tab.getAttribute('data-tab') === 'prayer-times') {
            loadPrayerTimes();
          }
        });
      });
      
      // Fetch media players from Home Assistant
      function loadMediaPlayers() {
        setStatusMessage('Media apparaten laden...', 'loading');
        
        fetch('/api/media_players')
          .then(response => response.json())
          .then(data => {
            mediaPlayers = data;
            
            // Clear previous options
            mediaPlayerSelect.innerHTML = '<option value="">Kies een mediaspeler...</option>';
            
            // Add options for each media player
            mediaPlayers.forEach(player => {
              const option = document.createElement('option');
              option.value = player.entity_id;
              option.textContent = `${player.name} (${player.state})`;
              mediaPlayerSelect.appendChild(option);
            });
            
            setStatusMessage(`${mediaPlayers.length} media apparaten geladen`, 'success');
          })
          .catch(error => {
            console.error('Error loading media players:', error);
            setStatusMessage('Fout bij laden van media apparaten', 'error');
          });
      }
      
      // Load songs from FamilyStream
      function loadSongs() {
        setStatusMessage('Liedjes laden...', 'loading');
        
        // Mock songs for now (in real implementation, fetch from FamilyStream API)
        songs = [
          { id: '1', title: 'Psalm 42', artist: 'Psalmen', duration: '3:25', url: 'https://web.familystream.com/listen/song/42' },
          { id: '2', title: 'Psalm 25', artist: 'Psalmen', duration: '4:10', url: 'https://web.familystream.com/listen/song/25' },
          { id: '3', title: 'Psalm 84', artist: 'Psalmen', duration: '2:55', url: 'https://web.familystream.com/listen/song/84' },
          { id: '4', title: 'Psalm 119', artist: 'Psalmen', duration: '5:30', url: 'https://web.familystream.com/listen/song/119' },
          { id: '5', title: 'Gebed des Heeren', artist: 'Geestelijke liederen', duration: '3:45', url: 'https://web.familystream.com/listen/song/gebed' },
          { id: '6', title: 'Avondzang', artist: 'Geestelijke liederen', duration: '2:30', url: 'https://web.familystream.com/listen/song/avond' },
          { id: '7', title: 'De Tien Geboden', artist: 'Geestelijke liederen', duration: '4:20', url: 'https://web.familystream.com/listen/song/geboden' },
          { id: '8', title: 'Morgenzang', artist: 'Geestelijke liederen', duration: '3:10', url: 'https://web.familystream.com/listen/song/morgen' }
        ];
        
        renderSongs(songs);
        setStatusMessage('Liedjes geladen', 'success');
      }
      
      // Render songs in the list
      function renderSongs(songsList) {
        const songsListElement = document.getElementById('songs-list');
        songsListElement.innerHTML = '';
        
        songsList.forEach(song => {
          const li = document.createElement('li');
          li.className = 'song-item';
          li.dataset.id = song.id;
          li.dataset.url = song.url;
          li.dataset.title = song.title;
          li.dataset.artist = song.artist;
          
          li.innerHTML = `
            <span class="play-icon">▶️</span>
            <span class="song-title">${song.title}</span>
            <span class="song-artist">${song.artist}</span>
            <span class="song-duration">${song.duration}</span>
          `;
          
          li.addEventListener('click', () => {
            currentSong = song;
            updateNowPlaying(song);
            playBtn.disabled = !mediaPlayerSelect.value;
            
            // Mark current song as active
            document.querySelectorAll('.song-item').forEach(item => {
              item.classList.remove('active');
            });
            li.classList.add('active');
            
            if (mediaPlayerSelect.value) {
              playSong(song);
            } else {
              setStatusMessage('Selecteer een mediaspeler om af te spelen', 'info');
            }
          });
          
          songsListElement.appendChild(li);
        });
        
        // Hide loading indicator
        document.querySelector('#songs-tab .loading').style.display = 'none';
      }
      
      // Load playlists from FamilyStream
      function loadPlaylists() {
        setStatusMessage('Afspeellijsten laden...', 'loading');
        
        // Mock playlists for now
        playlists = [
          { id: '1', name: 'Psalmen', songCount: 150, description: 'Alle psalmen' },
          { id: '2', name: 'Geestelijke liederen', songCount: 12, description: 'Geestelijke liederen bundel' },
          { id: '3', name: 'Favorieten', songCount: 20, description: 'Mijn favoriete nummers' }
        ];
        
        renderPlaylists(playlists);
        setStatusMessage('Afspeellijsten geladen', 'success');
      }
      
      // Render playlists
      function renderPlaylists(playlists) {
        playlistsContainer.innerHTML = '';
        
        playlists.forEach(playlist => {
          const div = document.createElement('div');
          div.className = 'playlist-item';
          div.dataset.id = playlist.id;
          
          div.innerHTML = `
            <div class="playlist-name">${playlist.name}</div>
            <div class="playlist-details">${playlist.songCount} nummers • ${playlist.description}</div>
          `;
          
          div.addEventListener('click', () => {
            // Load songs from this playlist
            setStatusMessage(`Nummers laden uit afspeellijst "${playlist.name}"...`, 'loading');
            
            // In real implementation, fetch songs from this playlist
            // For now, just simulate with mock data
            setTimeout(() => {
              const playlistSongs = songs.filter(song => {
                if (playlist.name === 'Psalmen') {
                  return song.artist === 'Psalmen';
                } else if (playlist.name === 'Geestelijke liederen') {
                  return song.artist === 'Geestelijke liederen';
                } else {
                  return song.id % 2 === 0; // Random selection for "Favorieten"
                }
              });
              
              // Switch to songs tab and show these songs
              tabs[0].click(); // Switch to songs tab
              renderSongs(playlistSongs);
              setStatusMessage(`Afspeellijst "${playlist.name}" geladen`, 'success');
            }, 500);
          });
          
          playlistsContainer.appendChild(div);
        });
        
        // Hide loading indicator
        document.querySelector('#playlists-tab .loading').style.display = 'none';
      }
      
      // Load prayer times
      function loadPrayerTimes() {
        setStatusMessage('Gebedstijden laden...', 'loading');
        
        // Mock prayer times
        const prayers = [
          { name: 'Fajr (Ochtendgebed)', time: '5:30' },
          { name: 'Dhuhr (Middaggebed)', time: '13:15' },
          { name: 'Asr (Namiddaggebed)', time: '15:45' },
          { name: 'Maghrib (Avondgebed)', time: '19:20' },
          { name: 'Isha (Nachtgebed)', time: '21:00' }
        ];
        
        prayerTimesContainer.innerHTML = '';
        
        prayers.forEach(prayer => {
          const div = document.createElement('div');
          div.className = 'prayer-item';
          
          div.innerHTML = `
            <span class="prayer-name">${prayer.name}</span>
            <span class="prayer-time">${prayer.time}</span>
          `;
          
          prayerTimesContainer.appendChild(div);
        });
        
        // Hide loading indicator
        document.querySelector('#prayer-times-tab .loading').style.display = 'none';
        setStatusMessage('Gebedstijden geladen', 'success');
      }
      
      // Update now playing information
      function updateNowPlaying(song) {
        nowPlaying.querySelector('.now-playing-title').textContent = song.title;
        nowPlaying.querySelector('.now-playing-artist').textContent = song.artist;
      }
      
      // Play a song on the selected media player
      function playSong(song) {
        const entityId = mediaPlayerSelect.value;
        if (!entityId) {
          setStatusMessage('Selecteer eerst een mediaspeler', 'error');
          return;
        }
        
        currentEntityId = entityId;
        
        setStatusMessage(`Audio naar ${entityId} sturen...`, 'loading');
        
        fetch('/api/play', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            entity_id: entityId,
            url: song.url,
            title: song.title,
            artist: song.artist,
            volume: volumeControl.value / 100
          }),
        })
          .then(response => response.json())
          .then(result => {
            if (result.success) {
              setStatusMessage(`"${song.title}" speelt nu op ${getMediaPlayerName(entityId)}`, 'success');
              enablePlayerControls();
            } else {
              setStatusMessage('Fout: ' + (result.error || 'Onbekende fout'), 'error');
            }
          })
          .catch(error => {
            console.error('Error playing song:', error);
            setStatusMessage('Fout bij afspelen', 'error');
          });
      }
      
      // Get media player name by entity ID
      function getMediaPlayerName(entityId) {
        const player = mediaPlayers.find(p => p.entity_id === entityId);
        return player ? player.name : entityId;
      }
      
      // Enable player controls
      function enablePlayerControls() {
        playBtn.disabled = false;
        pauseBtn.disabled = false;
        stopBtn.disabled = false;
      }
      
      // Disable player controls
      function disablePlayerControls() {
        playBtn.disabled = true;
        pauseBtn.disabled = true;
        stopBtn.disabled = true;
      }
      
      // Control media playback
      function controlMedia(action) {
        if (!currentEntityId) {
          setStatusMessage('Stuur eerst audio naar een apparaat', 'error');
          return;
        }
        
        fetch('/api/media_control', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            entity_id: currentEntityId,
            action: action
          }),
        })
          .then(response => response.json())
          .then(result => {
            if (result.success) {
              let actionText = '';
              if (action === 'play') actionText = 'Afspelen';
              else if (action === 'pause') actionText = 'Gepauzeerd';
              else if (action === 'stop') actionText = 'Gestopt';
              
              setStatusMessage(`${actionText} op ${getMediaPlayerName(currentEntityId)}`, 'success');
            } else {
              setStatusMessage('Fout: ' + (result.error || 'Onbekende fout'), 'error');
            }
          })
          .catch(error => {
            console.error(`Error sending ${action} command:`, error);
            setStatusMessage(`Fout bij versturen van ${action} commando`, 'error');
          });
      }
      
      // Set volume
      function setVolume() {
        if (!currentEntityId) return;
        
        const volume = volumeControl.value / 100;
        
        fetch('/api/volume', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            entity_id: currentEntityId,
            volume: volume
          }),
        })
          .then(response => response.json())
          .then(result => {
            if (result.success) {
              setStatusMessage(`Volume ingesteld op ${Math.round(volume * 100)}%`, 'success');
            }
          })
          .catch(error => {
            console.error('Error setting volume:', error);
          });
      }
      
      // Set status message
      function setStatusMessage(message, type = 'info') {
        statusMessage.textContent = message;
        statusMessage.className = 'status-message';
        
        if (type === 'error') {
          statusMessage.classList.add('error');
        } else if (type === 'success') {
          statusMessage.classList.add('success');
        }
      }
      
      // Handle search
      searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase();
        
        if (searchTerm.length === 0) {
          renderSongs(songs);
          return;
        }
        
        const filteredSongs = songs.filter(song => 
          song.title.toLowerCase().includes(searchTerm) || 
          song.artist.toLowerCase().includes(searchTerm)
        );
        
        renderSongs(filteredSongs);
      });
      
      // Event listeners
      refreshPlayersBtn.addEventListener('click', loadMediaPlayers);
      mediaPlayerSelect.addEventListener('change', () => {
        // If a song is selected and a media player is selected, enable the play button
        if (currentSong && mediaPlayerSelect.value) {
          playBtn.disabled = false;
        } else {
          playBtn.disabled = true;
        }
      });
      
      playBtn.addEventListener('click', () => {
        if (currentSong) {
          playSong(currentSong);
        } else {
          setStatusMessage('Selecteer eerst een nummer', 'error');
        }
      });
      
      pauseBtn.addEventListener('click', () => controlMedia('pause'));
      stopBtn.addEventListener('click', () => controlMedia('stop'));
      volumeControl.addEventListener('change', setVolume);
      
      // Initialize
      loadMediaPlayers();
      loadSongs();
    });
  </script>
</body>
</html> 